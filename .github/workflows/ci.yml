name: CI Test Coverage

on:
  workflow_dispatch:  # Manual trigger only for now
  pull_request:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for diff comparison

      - name: Setup PHP 8.1 with PCOV
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, bcmath, zip
          tools: composer:v2
          coverage: pcov  # Enable PCOV for coverage

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --optimize-autoloader

      # REQUIREMENT 3: Run unit tests with coverage
      - name: Run PHPUnit tests with coverage
        id: phpunit
        run: |
          echo "Creating coverage directory..."
          mkdir -p coverage
          
          echo "Running PHPUnit with coverage..."
          vendor/bin/phpunit \
            --coverage-clover=coverage/clover.xml \
            --coverage-html=coverage/html \
            --coverage-text \
            --colors=always

      # REQUIREMENT 4a: Print coverage report in console log
      - name: Display coverage summary in log
        if: always()
        run: |
          echo "=========================================="
          echo "         COVERAGE SUMMARY"
          echo "=========================================="
          if [ -f coverage/clover.xml ]; then
            php tools/check-coverage.php coverage/clover.xml 0 --display-only
          else
            echo "❌ Coverage report not found"
            exit 1
          fi
          echo "=========================================="

      # REQUIREMENT 4b: Upload HTML coverage report as artifact
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html-${{ github.run_number }}
          path: coverage/html/
          retention-days: 30

      - name: Upload coverage XML for analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-xml-${{ github.run_number }}
          path: coverage/clover.xml
          retention-days: 30

      # Check global coverage threshold (80%)
      - name: Check global coverage threshold (80%)
        id: check_coverage
        continue-on-error: true  # Don't fail on low global coverage
        run: |
          php tools/check-coverage.php coverage/clover.xml 80 > /tmp/coverage_output.txt 2>&1 || true
          COVERAGE=$(php tools/check-coverage.php coverage/clover.xml 0 --display-only 2>&1 | tail -n 1)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          cat /tmp/coverage_output.txt
          
          # Check if below 80% for warning
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "GLOBAL_COVERAGE_LOW=true" >> $GITHUB_ENV
            echo "⚠️  WARNING: Global coverage is below 80% ($COVERAGE%)"
          fi

      # REQUIREMENT 5: Calculate coverage diff (new code only)
      # Note: This step will be more useful when run on PRs
      - name: Get base branch for comparison
        id: get_base
        run: |
          # Try to detect base branch from current branch name or use main as default
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          
          # Default to main if not on a feature branch
          if [[ "$CURRENT_BRANCH" == "main" ]]; then
            echo "base_branch=main" >> $GITHUB_OUTPUT
            echo "skip_diff=true" >> $GITHUB_OUTPUT
          else
            echo "base_branch=main" >> $GITHUB_OUTPUT
            echo "skip_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Install diff-cover tool
        run: pip install diff-cover

      - name: Calculate diff coverage for changed code
        id: diff_coverage
        if: steps.get_base.outputs.skip_diff != 'true'
        continue-on-error: true
        run: |
          # Fetch the base branch
          git fetch origin ${{ steps.get_base.outputs.base_branch }} || true
          
          # Generate diff coverage report
          diff-cover coverage/clover.xml \
            --compare-branch=origin/${{ steps.get_base.outputs.base_branch }} \
            --html-report=coverage/diff-coverage.html \
            --json-report=coverage/diff-coverage.json \
            --fail-under=90 || echo "DIFF_FAILED=true" >> $GITHUB_ENV
          
          # Extract diff coverage percentage
          if [ -f coverage/diff-coverage.json ]; then
            DIFF_COV=$(cat coverage/diff-coverage.json | jq -r '.total_percent_covered // 0')
            echo "diff_coverage_pct=$DIFF_COV" >> $GITHUB_OUTPUT
            echo "Diff coverage: $DIFF_COV%"
          else
            echo "diff_coverage_pct=N/A" >> $GITHUB_OUTPUT
            echo "Could not calculate diff coverage"
          fi

      - name: Upload diff coverage report
        uses: actions/upload-artifact@v4
        if: steps.get_base.outputs.skip_diff != 'true'
        with:
          name: diff-coverage-report-${{ github.run_number }}
          path: coverage/diff-coverage.html
          retention-days: 30

      - name: Check diff coverage threshold
        if: steps.get_base.outputs.skip_diff != 'true' && steps.diff_coverage.outputs.diff_coverage_pct != 'N/A'
        run: |
          DIFF_COV=${{ steps.diff_coverage.outputs.diff_coverage_pct }}
          if (( $(echo "$DIFF_COV < 90" | bc -l) )); then
            echo "❌ BLOCKING: Diff coverage is $DIFF_COV% (threshold: 90%)"
            echo "DIFF_COVERAGE_FAILED=true" >> $GITHUB_ENV
            exit 1
          fi
          echo "✅ Diff coverage is $DIFF_COV% (threshold: 90%)"

      # REQUIREMENT 2: Set PR status check (prevents merge if failed)
      - name: Set status check - Test Coverage Gate
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const globalCoverage = '${{ steps.check_coverage.outputs.coverage }}';
            const diffCoverage = '${{ steps.diff_coverage.outputs.diff_coverage_pct }}';
            const coverageFailed = process.env.COVERAGE_FAILED === 'true';
            const testsFailed = '${{ steps.phpunit.outcome }}' !== 'success';
            const skipDiff = '${{ steps.get_base.outputs.skip_diff }}' === 'true';
            
            let conclusion = 'success';
            let summary = '✅ All coverage thresholds met';
            
            if (testsFailed) {
              conclusion = 'failure';
              summary = '❌ Unit tests failed';
            } else if (coverageFailed) {
              conclusion = 'failure';
              summary = `❌ Coverage thresholds NOT met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            } else {
              summary = `✅ Coverage thresholds met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            }
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Test Coverage Gate',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Test Coverage Check',
                summary: summary,
                text: conclusion === 'success' 
                  ? 'All tests passed and coverage thresholds met.' 
                  : 'Coverage thresholds not met or tests failed. Please add more tests.'
              }
            });

      # Post results summary
      - name: Coverage Results Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "       COVERAGE CHECK RESULTS"
          echo "========================================"
          echo ""
          echo "Global Coverage: ${{ steps.check_coverage.outputs.coverage }}%"
          
          if [ "${{ env.GLOBAL_COVERAGE_LOW }}" == "true" ]; then
            echo "  ⚠️  WARNING: Below 80% threshold (does not block merge)"
          else
            echo "  ✅ Meets 80% threshold"
          fi
          
          if [ "${{ steps.get_base.outputs.skip_diff }}" != "true" ] && [ "${{ steps.diff_coverage.outputs.diff_coverage_pct }}" != "N/A" ]; then
            echo ""
            echo "Diff Coverage (new code): ${{ steps.diff_coverage.outputs.diff_coverage_pct }}%"
            if [ "${{ env.DIFF_COVERAGE_FAILED }}" == "true" ]; then
              echo "  ❌ BLOCKING: Below 90% threshold - PR cannot be merged"
            else
              echo "  ✅ Meets 90% threshold"
            fi
          fi
          
          echo ""
          echo "Coverage Rules:"
          echo "  • Global < 80%: ⚠️  Warning only"
          echo "  • Diff < 90%: ❌ Blocks merge"
          echo ""
          echo "Artifacts available:"
          echo "  - HTML Coverage Report (coverage-report-html-${{ github.run_number }})"
          echo "  - XML Coverage Report (coverage-report-xml-${{ github.run_number }})"
          
          if [ "${{ steps.get_base.outputs.skip_diff }}" != "true" ]; then
            echo "  - Diff Coverage Report (diff-coverage-report-${{ github.run_number }})"
          fi
          
          echo ""
          echo "Download artifacts from:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""

      # Final step: Fail the job ONLY if diff coverage is below 90%
      - name: Final coverage check
        if: always()
        run: |
          if [ "${{ env.DIFF_COVERAGE_FAILED }}" == "true" ]; then
            echo ""
            echo "❌ MERGE BLOCKED: Diff coverage below 90%"
            echo ""
            echo "Your new/changed code has less than 90% test coverage."
            echo "Please add unit tests for the following:"
            echo "  • New methods/functions you added"
            echo "  • Modified code logic"
            echo "  • Edge cases and error handling"
            echo ""
            echo "Check the diff coverage report for specific uncovered lines."
            echo ""
            exit 1
          fi
          
          if [ "${{ env.GLOBAL_COVERAGE_LOW }}" == "true" ]; then
            echo ""
            echo "⚠️  WARNING: Global coverage is below 80%"
            echo "This is a warning only and does not block merge."
            echo "However, please consider improving overall test coverage."
            echo ""
          fi
          
          echo "✅ All blocking coverage checks passed!"

  # Optional: Slack notification
  # notify-failure:
  #   runs-on: ubuntu-latest
  #   needs: test-coverage
  #   if: failure()
    
  #   steps:
  #     - name: Send Slack notification
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' --data '{
  #           "text":"*Coverage Check Failure* :warning:\n*Repository:* `${{ github.repository }}`\n*Branch:* `${{ github.ref_name }}`\n*Workflow:* CI Test Coverage\n*Status:* :x: Coverage thresholds not met\n*Details:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
  #         }' ${{ secrets.SLACK_BUILDBOT_WEBHOOK_URL }}