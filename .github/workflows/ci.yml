name: CI Test Coverage

on:
  workflow_dispatch:  # Manual trigger only for now
  pull_request:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for diff comparison

      - name: Setup PHP 8.1 with PCOV
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, bcmath, zip
          tools: composer:v2
          coverage: pcov  # Enable PCOV for coverage

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --optimize-autoloader

      # REQUIREMENT 3: Run unit tests with coverage
      - name: Run PHPUnit tests with coverage
        id: phpunit
        run: |
          echo "Creating coverage directory..."
          mkdir -p coverage
          
          echo "Running PHPUnit with coverage..."
          vendor/bin/phpunit \
            --coverage-clover=coverage/clover.xml \
            --coverage-html=coverage/html \
            --coverage-text \
            --colors=always

      # REQUIREMENT 4a: Print coverage report in console log
      - name: Display coverage summary in log
        if: always()
        run: |
          echo "=========================================="
          echo "         COVERAGE SUMMARY"
          echo "=========================================="
          if [ -f coverage/clover.xml ]; then
            php tools/check-coverage.php coverage/clover.xml 0 --display-only
          else
            echo "❌ Coverage report not found"
            exit 1
          fi
          echo "=========================================="

      # REQUIREMENT 4b: Upload HTML coverage report as artifact
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html-${{ github.run_number }}
          path: coverage/html/
          retention-days: 30

      - name: Upload coverage XML for analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-xml-${{ github.run_number }}
          path: coverage/clover.xml
          retention-days: 30

      # Check global coverage threshold (80%)
      - name: Check global coverage threshold (80%)
        id: check_coverage
        run: |
          php tools/check-coverage.php coverage/clover.xml 80 > /tmp/coverage_output.txt 2>&1 || true
          COVERAGE=$(php tools/check-coverage.php coverage/clover.xml 0 --display-only 2>&1 | tail -n 1)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          cat /tmp/coverage_output.txt

      # --- START Barecheck Integration ---
      # REQUIREMENT 5: Calculate coverage diff (new code only) using Barecheck
      - name: Calculate diff coverage with Barecheck
        id: barecheck_coverage
        # Only run on pull_request to calculate diff coverage
        if: github.event_name == 'pull_request'
        uses: barecheck/barecheck@v1
        with:
          # Use the clover.xml generated by PHPUnit
          coverage-file: coverage/clover.xml
          # Set the minimum percentage of new code that must be covered
          minimum-coverage-on-changed-files: 90
          # Specify the output format for the report file. 'github-markdown' is often best for PR comments.
          output-format: github-markdown
          # Specify the output file path.
          output-file: coverage/diff-coverage-barecheck.md
          # Set the name of the output variable for the coverage percentage
          output-variable-name: diff_coverage_pct

      - name: Store Barecheck Diff Coverage result
        # Set environment variables for the final status check step
        if: always()
        run: |
          # Check if the Barecheck step was skipped (not a PR)
          if [ "${{ steps.barecheck_coverage.outcome }}" == "skipped" ]; then
            echo "skip_diff=true" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=N/A" >> $GITHUB_OUTPUT
          # Check if Barecheck failed its coverage threshold
          elif [ "${{ steps.barecheck_coverage.outcome }}" == "failure" ]; then
            echo "COVERAGE_FAILED=true" >> $GITHUB_ENV
            echo "skip_diff=false" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=${{ steps.barecheck_coverage.outputs.diff_coverage_pct }}" >> $GITHUB_OUTPUT
          # Barecheck succeeded (or wasn't run on a PR that wasn't main)
          else
            echo "skip_diff=false" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=${{ steps.barecheck_coverage.outputs.diff_coverage_pct }}" >> $GITHUB_OUTPUT
          fi
          
      # Upload Barecheck diff report (optional, but good for artifacts)
      - name: Upload Barecheck diff coverage report
        uses: actions/upload-artifact@v4
        if: steps.barecheck_coverage.outcome != 'skipped' && always()
        with:
          name: diff-coverage-report-barecheck-${{ github.run_number }}
          path: coverage/diff-coverage-barecheck.md
          retention-days: 30
      # --- END Barecheck Integration ---

      # REQUIREMENT 2: Set PR status check (prevents merge if failed)
      - name: Set status check - Test Coverage Gate
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const globalCoverage = '${{ steps.check_coverage.outputs.coverage }}';
            // Use the value stored in the previous step
            const diffCoverage = '${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}'; 
            const coverageFailed = process.env.COVERAGE_FAILED === 'true';
            const testsFailed = '${{ steps.phpunit.outcome }}' !== 'success';
            // Use the value stored in the previous step
            const skipDiff = '${{ steps.store_barecheck_diff_coverage_result.outputs.skip_diff }}' === 'true'; 
            
            let conclusion = 'success';
            let summary = '✅ All coverage thresholds met';
            
            if (testsFailed) {
              conclusion = 'failure';
              summary = '❌ Unit tests failed';
            } else if (coverageFailed) {
              conclusion = 'failure';
              summary = `❌ Coverage thresholds NOT met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            } else {
              summary = `✅ Coverage thresholds met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            }
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Test Coverage Gate',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Test Coverage Check',
                summary: summary,
                text: conclusion === 'success' 
                  ? 'All tests passed and coverage thresholds met.' 
                  : 'Coverage thresholds not met or tests failed. Please add more tests.'
              }
            });

      # Post results summary
      - name: Coverage Results Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "       COVERAGE CHECK RESULTS"
          echo "========================================"
          echo ""
          echo "Global Coverage: ${{ steps.check_coverage.outputs.coverage }}% (threshold: 80%)"
          
          # Use the outputs from the Barecheck store step
          if [ "${{ steps.store_barecheck_diff_coverage_result.outputs.skip_diff }}" != "true" ] && [ "${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}" != "N/A" ]; then
            echo "Diff Coverage: ${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}% (threshold: 90%)"
          fi
          
          echo ""
          echo "Artifacts available:"
          echo "  - HTML Coverage Report (coverage-report-html-${{ github.run_number }})"
          echo "  - XML Coverage Report (coverage-report-xml-${{ github.run_number }})"
          
          # Use the outputs from the Barecheck store step
          if [ "${{ steps.store_barecheck_diff_coverage_result.outputs.skip_diff }}" != "true" ]; then
            echo "  - Barecheck Diff Coverage Report (diff-coverage-report-barecheck-${{ github.run_number }})"
          fi
          
          echo ""
          echo "Download artifacts from:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""

      # Final step: Fail the job if coverage thresholds not met
      - name: Final coverage check
        if: always()
        run: |
          if [ "${{ env.COVERAGE_FAILED }}" == "true" ]; then
            echo "❌ Coverage checks failed. Please review the coverage reports and add more tests."
            exit 1
          fi
          echo "✅ All coverage checks passed!"

  # Optional: Slack notification
  # notify-failure:
  #   runs-on: ubuntu-latest
  #   needs: test-coverage
  #   if: failure()
    
  #   steps:
  #     - name: Send Slack notification
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' --data '{
  #           "text":"*Coverage Check Failure* :warning:\n*Repository:* `${{ github.repository }}`\n*Branch:* `${{ github.ref_name }}`\n*Workflow:* CI Test Coverage\n*Status:* :x: Coverage thresholds not met\n*Details:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
  #         }' ${{ secrets.SLACK_BUILDBOT_WEBHOOK_URL }}