name: CI Test Coverage

on:
  workflow_dispatch:  # Manual trigger only for now
  pull_request:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for diff comparison

      - name: Setup PHP 8.1 with PCOV
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, bcmath, zip
          tools: composer:v2
          coverage: pcov  # Enable PCOV for coverage

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --optimize-autoloader

      # REQUIREMENT 3: Run unit tests with coverage - GENERATING LCOV ONLY
      - name: Run PHPUnit tests with coverage (LCOV)
        id: phpunit
        run: |
          echo "Creating coverage directory..."
          mkdir -p coverage
          
          # Run PHPUnit, output LCOV, and capture text output for global coverage analysis
          echo "Running PHPUnit with LCOV coverage..."
          vendor/bin/phpunit \
            --coverage-lcov=coverage/lcov.info \
            --coverage-html=coverage/html \
            --coverage-text > coverage/phpunit_output.txt 2>&1 || true

      # REQUIREMENT 4a: Print coverage report in console log (using updated PHP script)
      - name: Display coverage summary in log
        if: always()
        run: |
          echo "=========================================="
          echo "         COVERAGE SUMMARY"
          echo "=========================================="
          if [ -f coverage/phpunit_output.txt ]; then
            # Call the updated PHP script using the text output file
            php tools/check-coverage.php coverage/phpunit_output.txt 0 --display-only
          else
            echo "‚ùå PHPUnit output not found"
            exit 1
          fi
          echo "=========================================="

      # REQUIREMENT 4b: Upload HTML coverage report as artifact
      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html-${{ github.run_number }}
          path: coverage/html/
          retention-days: 30

      # Upload LCOV file for Barecheck analysis
      - name: Upload LCOV file for analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-lcov-${{ github.run_number }}
          path: coverage/lcov.info
          retention-days: 30

      # Check global coverage threshold (80%) - Using updated PHP script
      - name: Check global coverage threshold (80%)
        id: check_coverage
        run: |
          # The PHP script runs the check and prints the final percentage as the last line
          php tools/check-coverage.php coverage/phpunit_output.txt 80 > /tmp/coverage_output.txt 2>&1 || true
          
          # Extract the final numeric percentage (last line of output)
          COVERAGE=$(tail -n 1 /tmp/coverage_output.txt)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          
          # Print the detailed output for logging
          cat /tmp/coverage_output.txt

      # --- START Barecheck Integration ---
      # REQUIREMENT 5: Calculate coverage diff (new code only) using Barecheck
      - name: üîç Calculate diff coverage with Barecheck
        id: barecheck_coverage
        # Only run on pull_request to calculate diff coverage
        if: github.event_name == 'pull_request'
        uses: barecheck/code-coverage-action@v1 
        with:
          # Use the directly generated LCOV file
          lcov-file: coverage/lcov.info
          # Set the minimum percentage of new code that must be covered
          minimum-ratio: 90
          output-variable-name: diff_coverage_pct

      - name: Store Barecheck Diff Coverage result
        id: store_barecheck_diff_coverage_result
        if: always()
        run: |
          # If Barecheck failed its coverage threshold, it fails the step.
          if [ "${{ steps.barecheck_coverage.outcome }}" == "failure" ]; then
            echo "COVERAGE_FAILED=true" >> $GITHUB_ENV
            echo "skip_diff=false" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=${{ steps.barecheck_coverage.outputs.diff_coverage_pct }}" >> $GITHUB_OUTPUT
          # If Barecheck was skipped (not a PR)
          elif [ "${{ steps.barecheck_coverage.outcome }}" == "skipped" ]; then
            echo "skip_diff=true" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=N/A" >> $GITHUB_OUTPUT
          # Barecheck succeeded
          else
            echo "skip_diff=false" >> $GITHUB_OUTPUT
            echo "diff_coverage_pct=${{ steps.barecheck_coverage.outputs.diff_coverage_pct }}" >> $GITHUB_OUTPUT
          fi
          
      # --- END Barecheck Integration ---

      # REQUIREMENT 2: Set PR status check (prevents merge if failed)
      - name: Set status check - Test Coverage Gate
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            // Check if the PHP script exit code was 1 (failure)
            const globalCheckFailed = '${{ steps.check_coverage.outcome }}' === 'failure';
            const globalCoverage = '${{ steps.check_coverage.outputs.coverage }}'; 
            const diffCoverage = '${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}'; 
            // 'COVERAGE_FAILED' is set by either the global check (if it fails) or the Barecheck step
            const coverageFailed = process.env.COVERAGE_FAILED === 'true' || globalCheckFailed; 
            const testsFailed = '${{ steps.phpunit.outcome }}' !== 'success';
            const skipDiff = '${{ steps.store_barecheck_diff_coverage_result.outputs.skip_diff }}' === 'true'; 
            
            let conclusion = 'success';
            let summary = '‚úÖ All coverage thresholds met';
            
            if (testsFailed) {
              conclusion = 'failure';
              summary = '‚ùå Unit tests failed';
            } else if (coverageFailed) {
              conclusion = 'failure';
              summary = `‚ùå Coverage thresholds NOT met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            } else {
              summary = `‚úÖ Coverage thresholds met\n\nGlobal: ${globalCoverage}% (min: 80%)`;
              if (!skipDiff && diffCoverage !== 'N/A') {
                summary += `\nDiff: ${diffCoverage}% (min: 90%)`;
              }
            }
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Test Coverage Gate',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Test Coverage Check',
                summary: summary,
                text: conclusion === 'success' 
                  ? 'All tests passed and coverage thresholds met.' 
                  : 'Coverage thresholds not met or tests failed. Please add more tests.'
              }
            });

      # Post results summary
      - name: Coverage Results Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "       COVERAGE CHECK RESULTS"
          echo "========================================"
          echo ""
          echo "Global Coverage: ${{ steps.check_coverage.outputs.coverage }}% (threshold: 80%)"
          
          if [ "${{ steps.store_barecheck_diff_coverage_result.outputs.skip_diff }}" != "true" ] && [ "${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}" != "N/A" ]; then
            echo "Diff Coverage: ${{ steps.store_barecheck_diff_coverage_result.outputs.diff_coverage_pct }}% (threshold: 90%)"
          fi
          
          echo ""
          echo "Artifacts available:"
          echo "  - HTML Coverage Report (coverage-report-html-${{ github.run_number }})"
          echo "  - LCOV Coverage File (coverage-report-lcov-${{ github.run_number }})"
          
          echo ""
          echo "Download artifacts from:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""

      # Final step: Fail the job if coverage thresholds not met
      - name: Final coverage check
        if: always()
        run: |
          if [ "${{ steps.check_coverage.outcome }}" == "failure" ] || [ "${{ env.COVERAGE_FAILED }}" == "true" ]; then
            echo "‚ùå Coverage checks failed. Please review the coverage reports and add more tests."
            exit 1
          fi
          echo "‚úÖ All coverage checks passed!"
          
  # Optional: Slack notification
  # notify-failure:
  #   runs-on: ubuntu-latest
  #   needs: test-coverage
  #   if: failure()
    
  #   steps:
  #     - name: Send Slack notification
  #       run: |
  #         curl -X POST -H 'Content-type: application/json' --data '{
  #           "text":"*Coverage Check Failure* :warning:\n*Repository:* `${{ github.repository }}`\n*Branch:* `${{ github.ref_name }}`\n*Workflow:* CI Test Coverage\n*Status:* :x: Coverage thresholds not met\n*Details:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
  #         }' ${{ secrets.SLACK_BUILDBOT_WEBHOOK_URL }}